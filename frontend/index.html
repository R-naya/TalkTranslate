<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <title>TalkTranslate</title>
    </head>
    <body>
        <h1>TalkTranslate</h1>

        <p>Entrez un texte à traduire :</p>

        <input type="text" id="textInput" placeholder="Ex : bonjour">
        <select id="languageSelect">
            <option value="en">Anglais</option>
            <option value="es">Espagnol</option>
            <option value="de">Allemand</option>
        </select>

        <button id="translateButton">Traduire</button>

        <h2>Résultat :</h2>
        <p><strong>Transcription :</strong> <span id="transcription"></span></p>
        <p><strong>Traduction :</strong> <span id="translation"></span></p>
        <p id="translateStatus"></p>
        <p id="translateError" style="color: red;"></p>

        <hr>

        <h2>Capture audio (test)</h2>
        <button id="recordButton">Démarrer l'enregistrement</button>
        <p id="recordStatus"></p>
        <p id="recordError" style="color: red;"></p>

        <div id="audioResult" style="display:none;">
            <p>Audio enregistré :</p>
            <audio id="audioPlayer" controls></audio>
            <p><a id="downloadLink" download="recording.webm">Télécharger</a></p>
        </div>

        <script>
            const translateButton = document.getElementById("translateButton");
            const translateStatus = document.getElementById("translateStatus");
            const translateError = document.getElementById("translateError");

            translateButton.addEventListener("click", async () => {
                const text = document.getElementById("textInput").value;
                const lang = document.getElementById("languageSelect").value;

                translateError.textContent = "";
                translateStatus.textContent = "Traduction en cours...";
                translateButton.disabled = true;

                try {
                    const response = await fetch("http://127.0.0.1:5000/process", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({
                            text: text,
                            target_lang: lang
                        })
                    });

                    if (!response.ok) {
                        throw new Error("Réponse serveur invalide");
                    }

                    const data = await response.json();

                    document.getElementById("transcription").textContent = data.transcription || "";
                    document.getElementById("translation").textContent = data.translated || "";

                    translateStatus.textContent = "Traduction terminée";
                } catch (error) {
                    translateStatus.textContent = "";
                    translateError.textContent = "Erreur : impossible de contacter le backend."
                    console.error(error);
                } finally {
                    translateButton.disabled = false;
                }
            });

            const recordButton = document.getElementById("recordButton");
            const recordStatus = document.getElementById("recordStatus");
            const audioResult = document.getElementById("audioResult");
            const audioPlayer = document.getElementById("audioPlayer");
            const downloadLink = document.getElementById("downloadLink");
            const recordError = document.getElementById("recordError");

            let mediaRecorder = null;
            let audioChunks = [];

            recordButton.addEventListener("click", async () => {
                audioResult.style.display = "none";
                audioChunks = [];
                recordError.textContent = "";
                recordButton.disabled = true;
                recordStatus.textContent = "Enregistrement en cours...";

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true});
                    console.log("Accès au micro autorisé");

                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data && event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const formData = new FormData();
                        formData.append("audio", audioBlob, downloadLink.download || "recording.webm");

                        fetch("http://127.0.0.1:5000/upload_audio", {
                            method: "POST",
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log("Backend :", data);
                            recordStatus.textContent = "Audio envoyé";

                            if (data.transcription) {
                                document.getElementById("transcription").textContent = data.transcription;
                            }

                            recordButton.disabled = false;

                        })
                        .catch(error => {
                            recordStatus.textContent = "";
                            recordError.textContent = "Erreur : upload audio impossible.";
                            recordButton.disabled = false;
                            console.error(error);
                        });

                        audioPlayer.src = audioUrl;
                        downloadLink.href = audioUrl;

                        audioResult.style.display = "block";
                        recordStatus.textContent = "Enregistrement terminé";

                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    recordStatus.textContent = "Enregistrement en cours...";
                    console.log("Enregistrement démarré");

                    setTimeout(() => {
                        mediaRecorder.stop();
                        console.log("Enregistrement arrêté");
                    }, 3000);
                } catch (err) {
                    console.error("Erreur accès micro :", err);
                    recordStatus.textContent = "";
                    recordError.textContent = "Impossible d’accéder au micro.";
                    recordButton.disabled = false;
                }
            });
        </script>
    </body>
</html>